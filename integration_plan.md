# Morrowind AI Framework - OpenMW Integration Plan

## Overview

This document outlines the step-by-step process for integrating the Morrowind AI Framework with OpenMW 0.49.0. The integration will enable NPCs in Morrowind to generate dynamic, contextually aware dialogue using the AI server we've already set up.

## Prerequisites

- OpenMW 0.49.0 source code
- C++ compiler with C++17 support
- CMake 3.12 or later
- Boost libraries (for WebSocket client)
- Morrowind AI Framework components (already available)

## Integration Steps

### 1. Prepare Development Environment

1. Clone OpenMW repository (if not already done):
   ```bash
   git clone https://github.com/OpenMW/openmw.git
   cd openmw
   git checkout openmw-0.49.0  # Ensure we're using the correct version
   ```

2. Create a new branch for our AI integration:
   ```bash
   git checkout -b morrowind-ai-integration
   ```

3. Set up build directory:
   ```bash
   mkdir build
   cd build
   ```

### 2. Add AI Components to OpenMW

1. Copy AI client components to OpenMW source tree:
   ```bash
   cp -r /path/to/morrowind_ai_framework/openmw-client/components/ai_client components/
   cp -r /path/to/morrowind_ai_framework/openmw-client/components/openmw-mp components/
   cp -r /path/to/morrowind_ai_framework/openmw-client/components/lua components/
   ```

2. Update CMake configuration to include new components:
   - Edit `components/CMakeLists.txt` to add:
     ```cmake
     add_component_dir(ai_client
         client
     )
     ```

3. Copy Lua scripts to OpenMW resources directory:
   ```bash
   cp -r /path/to/morrowind_ai_framework/openmw-client/resources/lua resources/
   ```

### 3. Apply Engine Modifications

1. Apply the patch to OpenMW engine:
   ```bash
   git apply /path/to/morrowind_ai_framework/openmw-source/apps/openmw/engine.cpp.patch
   ```

2. Verify the patch applied correctly:
   - Check that `engine.cpp` and `engine.hpp` have been modified
   - Ensure `environment.cpp` and `environment.hpp` have been updated
   - Confirm that the AI Manager is properly integrated

### 4. Configure OpenMW for AI Integration

1. Update OpenMW configuration file (`openmw.cfg`):
   ```
   # Enable Lua scripting
   enable lua = true

   # Load AI Framework Lua scripts
   lua ai_npc_dialogue.lua

   # AI Server connection settings
   ai server host = localhost
   ai server port = 8082  # Use the port we configured for our AI server
   ```

### 5. Build Modified OpenMW

1. Configure the build:
   ```bash
   cmake ..
   ```

2. Build OpenMW:
   ```bash
   make -j$(nproc)  # Use appropriate number of cores
   ```

### 6. Testing the Integration

1. Start the AI server:
   ```bash
   cd /path/to/morrowind_ai_framework/ai-server
   ./start_server.bat  # or ./start_server.sh on Linux/macOS
   ```

2. Launch modified OpenMW:
   ```bash
   cd /path/to/openmw/build
   ./openmw
   ```

3. Test with example NPC:
   - Add the following script to an NPC in the game:
     ```
     Begin AIDialogue
         NPCId "example_npc"
     End
     ```
   - Talk to the NPC and verify that the dialogue is generated by the AI server

## Troubleshooting

### Common Issues

1. **Connection Issues**:
   - Ensure the AI server is running
   - Check that the host/port settings in `openmw.cfg` match the AI server
   - Verify network connectivity between OpenMW and the AI server

2. **Missing Dialogue**:
   - Check that the NPC has the correct script
   - Ensure the NPC ID matches a profile in the AI server
   - Verify that the AI server is generating responses

3. **Build Errors**:
   - Check for missing dependencies
   - Ensure all paths are correct
   - Verify that the patch applied correctly

4. **Runtime Errors**:
   - Check the OpenMW log for error messages
   - Look for WebSocket connection errors
   - Verify that the AI Manager is properly initialized

## Rollback Plan

If the integration causes issues:

1. Revert to the original OpenMW branch:
   ```bash
   git checkout openmw-0.49.0
   ```

2. Rebuild OpenMW:
   ```bash
   cd build
   make clean
   make -j$(nproc)
   ```

## Future Improvements

1. **Error Handling**: Improve error handling for AI server connection issues
2. **Performance Optimization**: Optimize WebSocket communication
3. **Memory Management**: Implement better memory management for NPC contexts
4. **UI Improvements**: Add UI indicators for AI-powered NPCs
5. **Configuration**: Add more configuration options for AI behavior
